<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Municipal Admin Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 20px;
      background: #f8fafc;
      color: #333;
    }

    h1 { color: #1e3a8a; }
    p { color: #555; }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
    }

    th {
      background: #1e3a8a;
      color: white;
    }

    tr.pending { background-color: #fffbea; }
    tr.resolved { background-color: #e6ffe6; }
    tr.high { border-left: 5px solid #ef4444; }
    tr.normal { border-left: 5px solid #22c55e; }

    button {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    button:hover { background: #16a34a; }

    img {
      max-width: 80px;
      border-radius: 8px;
    }

    /* Map container hidden initially */
    #map-container {
      display: none;
      margin-top: 20px;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
    }

    .watermark {
      font-size: 0.8rem;
      color: #888;
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üèõÔ∏è Municipal Admin Dashboard</h1>
  <p>Click any issue to view its location.</p>

  <div class="top-bar">
    <p>Click once to enable sound notifications.</p>
    <select id="sort-options">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="pending">Pending Only</option>
      <option value="resolved">Resolved Only</option>
    </select>
  </div>

  <audio id="tung-sound" src="sounds/PING_DING.mp3" preload="auto"></audio>

  <table>
    <thead>
      <tr>
        <th>Priority</th>
        <th>Title</th>
        <th>Description</th>
        <th>Photo</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="issues-list"></tbody>
  </table>

  <!-- MAP THAT IS HIDDEN UNTIL CLICKED -->
  <div id="map-container">
    <h2>üìç Issue Location</h2>
    <div id="map"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- Firebase Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyALR6o6lQzX_jR6mctmUWaHqlltUzfKkoc",
      authDomain: "civics-tracker-demo.firebaseapp.com",
      projectId: "civics-tracker-demo",
      storageBucket: "civics-tracker-demo.appspot.com",
      messagingSenderId: "246778238801",
      appId: "1:246778238801:web:11e188c8925a307572a570"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const sortSelect = document.getElementById("sort-options");
    const list = document.getElementById("issues-list");

    let knownIds = new Set();
    let soundUnlocked = false;
    const sound = document.getElementById("tung-sound");

    document.body.addEventListener('click', () => {
      if (!soundUnlocked) {
        sound.play().then(() => {
          sound.pause();
          sound.currentTime = 0;
          soundUnlocked = true;
        }).catch(() => {});
      }
    }, { once: true });

    // --- Map Setup (but hidden) ---
    const mapContainer = document.getElementById("map-container");
    let map;
    let mapInitialized = false;
    let pointer;

    function initMap() {
      if (mapInitialized) return;
      mapInitialized = true;

      map = L.map('map').setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }

    sortSelect.addEventListener("change", () => loadIssues(sortSelect.value));

    // --- Main Loader ---
    function loadIssues(sortOption = "newest") {
      let query = db.collection('issues');

      if (sortOption === "pending") query = query.where("status", "==", "pending");
      if (sortOption === "resolved") query = query.where("status", "==", "resolved");
      if (sortOption === "newest") query = query.orderBy("createdAt", "desc");
      if (sortOption === "oldest") query = query.orderBy("createdAt", "asc");

      query.onSnapshot(snapshot => {
        list.innerHTML = "";

        snapshot.forEach(doc => {
          const issue = doc.data();
          const tr = document.createElement('tr');

          // Priority detection  
          let priority = "Normal";
          const text = (issue.title + " " + issue.description).toLowerCase();
          if (text.includes("accident") || text.includes("fire") || text.includes("danger"))
            priority = "High";

          tr.classList.add(issue.status);
          tr.classList.add(priority === "High" ? "high" : "normal");

          tr.innerHTML = `
            <td><b>${priority}</b></td>
            <td>${issue.title}</td>
            <td>${issue.description}</td>
            <td>${issue.photoURL ? `<img src="${issue.photoURL}">` : "No photo"}</td>
            <td>${issue.status}</td>
            <td>
              ${issue.status === "pending" ?
                `<button onclick="resolveIssue('${doc.id}')">Resolve</button>
                 <br><input type="file" id="file-${doc.id}">`
                 : "‚Äî"}
            </td>
          `;

          // CLICK ROW ‚Üí SHOW MAP + JUMP TO LOCATION
          tr.onclick = () => {
            if (!issue.lat || !issue.lng) {
              alert("No location for this issue.");
              return;
            }

            mapContainer.style.display = "block";
            initMap();

            map.setView([issue.lat, issue.lng], 16);

            if (pointer) {
              pointer.setLatLng([issue.lat, issue.lng]);
            } else {
              pointer = L.marker([issue.lat, issue.lng]).addTo(map);
            }
          };

          list.appendChild(tr);
        });
      });
    }

    // Resolve function
    async function resolveIssue(id) {
      const fileInput = document.getElementById(`file-${id}`);
      let resolvedPhotoURL = "";

      if (fileInput && fileInput.files[0]) {
        const file = fileInput.files[0];
        const ref = storage.ref().child(`resolved/${Date.now()}_${file.name}`);
        await ref.put(file);
        resolvedPhotoURL = await ref.getDownloadURL();
      }

      await db.collection("issues").doc(id).update({
        status: "resolved",
        resolvedPhotoURL
      });
    }

    loadIssues();
  </script>

  <div class="watermark">¬© 2025 Civics Tracker | Kunal Mistry</div>
</body>
</html>
